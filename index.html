<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nutri Tracker ‚Äì UI Prototype</title>
<style>
:root{
  --bg:#0e1117; --card:#111827; --soft:#0b1220;
  --txt:#f3f4f6; --muted:#9ca3af; --accent:#6366f1;
  --ok:#34d399; --bad:#fb7185; --warn:#fbbf24;
  --r:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
header{padding:18px 20px;background:rgba(17,24,39,.9);backdrop-filter:blur(10px);position:sticky;top:0;border-bottom:1px solid rgba(255,255,255,.06)}
header .row{justify-content:space-between}
h1{margin:0;font-size:18px}
small{color:var(--muted)}
.container{max-width:1050px;margin:0 auto;padding:18px;display:grid;gap:16px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start}
@media(max-width:920px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);padding:14px}
.card h2{margin:0 0 10px 0;font-size:13px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button{
  background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:12px;cursor:pointer;
  font-weight:700
}
button.secondary{background:#374151}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.14)}
button.danger{background:rgba(251,113,133,.22);border:1px solid rgba(251,113,133,.45)}
button.small{padding:7px 10px;border-radius:10px;font-weight:700}
button:disabled{opacity:.55;cursor:not-allowed}
label{font-size:12px;color:var(--muted)}
input,select{
  background:var(--soft);border:1px solid rgba(255,255,255,.12);color:var(--txt);
  padding:9px 10px;border-radius:10px;outline:none
}
input[type="number"]{width:110px}
input.wide{width:min(420px, 85vw)}
.pill{font-size:12px;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.18);color:var(--muted)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:600px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(--soft);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;text-align:center}
.kpi b{display:block;font-size:18px;margin-top:2px}
.list{display:grid;gap:10px}
.item{
  background:var(--soft);
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  padding:12px;
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:flex-start;
}
.item b{display:block}
.item small{display:block;margin-top:4px}
.actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;color:#c7d2fe}
.notice{border-left:3px solid var(--warn);padding:10px 12px;background:rgba(251,191,36,.08);border-radius:12px;color:rgba(255,255,255,.84);font-size:13px;line-height:1.35}
.notice b{color:#fff}
.notice.ok{border-left-color:var(--ok);background:rgba(52,211,153,.08)}
.notice.err{border-left-color:var(--bad);background:rgba(251,113,133,.08)}
.editing{
  outline:2px solid rgba(124,92,255,.45);
  box-shadow: 0 0 0 6px rgba(124,92,255,.10);
}

/* suggestions dropdown */
.suggestions{ position:relative; width:min(520px, 92vw); }
.sugbox{
  position:absolute; top: calc(100% + 6px); left:0; right:0;
  background: rgba(11,18,32,.98);
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  overflow:hidden;
  display:none;
  z-index: 30;
}
.sugitem{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.08); }
.sugitem:last-child{border-bottom:none}
.sugitem:hover{background: rgba(255,255,255,.06)}
.sugitem b{font-size:13px}
.sugitem small{display:block;margin-top:2px;color:rgba(255,255,255,.65)}

/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.78);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
.modal .box{width:min(680px, 100%);background:rgba(17,24,39,.95);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px}
.videoWrap{margin-top:10px;border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden;background:#000;position:relative}
video{width:100%;height:360px;object-fit:cover;display:block}
@media(max-width:520px){video{height:300px}}
.ret{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
.ret:before{content:"";width:min(320px,78%);height:120px;border-radius:16px;border:2px dashed rgba(255,255,255,.28);box-shadow:0 0 0 999px rgba(0,0,0,.18)}
.ret span{position:absolute;bottom:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;color:rgba(255,255,255,.75);font-size:12px}
</style>
</head>
<body>

<header>
  <div class="row">
    <div>
      <h1>Nutri Tracker</h1>
      <small>UI Prototyp ¬∑ Auto-Werte: USDA (Name) & Open Food Facts (Barcode)</small>
    </div>
    <div class="row">
      <span class="pill">Datum: <span id="todayPill"></span></span>
      <button class="ghost" id="settingsBtn" title="USDA Key speichern">‚öôÔ∏è Settings</button>
      <button id="scanBtn">üì∑ Barcode scannen</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="card" id="manualCard">
      <h2>Manuell eintragen (mit Auto-Suche)</h2>

      <div class="row">
        <div class="suggestions">
          <label>Was?<br>
            <input id="manualName" class="wide" placeholder="z.B. Brokkoli (Tippen ‚Üí Vorschl√§ge)" autocomplete="off" />
          </label>
          <div class="sugbox" id="sugbox"></div>
        </div>

        <label>Gramm<br><input id="manualGrams" type="number" min="0" value="200" /></label>
        <label>kcal / 100g<br><input id="manualKcal" type="number" min="0" value="0" /></label>
        <label>Protein / 100g<br><input id="manualP" type="number" min="0" value="0" step="0.1" /></label>
        <label>Carbs / 100g<br><input id="manualC" type="number" min="0" value="0" step="0.1" /></label>
        <label>Fett / 100g<br><input id="manualF" type="number" min="0" value="0" step="0.1" /></label>
        <label>Mahlzeit<br>
          <select id="meal">
            <option>Fr√ºhst√ºck</option>
            <option>Mittag</option>
            <option>Abend</option>
            <option>Snack</option>
          </select>
        </label>

        <button id="manualAdd">‚ûï Eintragen</button>
        <button id="manualSave" class="secondary" hidden>üíæ √Ñnderungen speichern</button>
        <button id="manualCancel" class="ghost" hidden>Abbrechen</button>
      </div>

      <div class="row" style="margin-top:10px">
        <span class="pill">Barcode (optional): <code id="activeBarcode">‚Äî</code></span>
        <span class="pill">Quelle: <span id="sourceTag">manuell</span></span>
      </div>

      <div class="notice" style="margin-top:10px" id="topNote">
        <b>Wichtig (simpel):</b> F√ºr USDA brauchst du einen Key. Klick auf <code>‚öôÔ∏è Settings</code> und f√ºge ihn ein (wird im Browser gespeichert).
      </div>
    </div>

    <div class="card">
      <h2>Tages-Summe</h2>
      <div class="kpis">
        <div class="kpi"><small>kcal</small><b id="sumKcal">0</b></div>
        <div class="kpi"><small>Protein</small><b id="sumP">0.0g</b></div>
        <div class="kpi"><small>Carbs</small><b id="sumC">0.0g</b></div>
        <div class="kpi"><small>Fett</small><b id="sumF">0.0g</b></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Eintr√§ge</h2>
    <div class="list" id="entries"></div>
  </div>
</div>

<!-- SCANNER MODAL -->
<div class="modal" id="scanModal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>
        <b>Barcode scannen</b><br>
        <small id="scanStatus">Starte Kamera‚Ä¶</small>
      </div>
      <div class="row">
        <button class="ghost" id="switchCam">‚Ü∫ Kamera wechseln</button>
        <button class="secondary" id="closeScan">Schlie√üen</button>
      </div>
    </div>

    <div class="videoWrap">
      <video id="video" playsinline muted></video>
      <div class="ret"><span>Barcode im Rahmen halten</span></div>
    </div>

    <div style="margin-top:10px" class="row">
      <span class="pill">Letzter Scan: <code id="lastCode">‚Äî</code></span>
      <button class="secondary" id="manualCodeBtn">Code manuell eingeben</button>
    </div>

    <div class="notice" style="margin-top:10px" id="scanNote"></div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>
        <b>Settings</b><br>
        <small>USDA Key speichern (im Browser / LocalStorage)</small>
      </div>
      <button class="secondary" id="closeSettings">Schlie√üen</button>
    </div>

    <div class="notice" style="margin-top:10px">
      <b>Hinweis:</b> Das ist absichtlich ‚Äûquick & dirty‚Äú. Der Key wird lokal im Browser gespeichert.
      Wenn du sp√§ter doch ‚Äûrichtig‚Äú willst, migrieren wir auf Firebase Functions.
    </div>

    <div class="row" style="margin-top:12px">
      <label style="flex:1">USDA API Key<br>
        <input id="usdaKeyInput" class="wide" placeholder="hier einf√ºgen‚Ä¶" />
      </label>
      <button id="saveKeyBtn">üíæ Speichern</button>
      <button class="danger small" id="clearKeyBtn">Key l√∂schen</button>
    </div>

    <div class="row" style="margin-top:10px">
      <span class="pill">Status: <span id="keyStatus">‚Äî</span></span>
    </div>
  </div>
</div>

<script>
let entries = [];
let editingId = null;

const $ = (id) => document.getElementById(id);
const fmt = (n,d=1) => (Number(n)||0).toFixed(d);
const fmt0 = (n) => Math.round(Number(n)||0);

function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function calcFromPer100(per100, grams){
  const f = (Number(grams)||0)/100;
  return {
    kcal: (Number(per100.kcal)||0) * f,
    protein_g: (Number(per100.protein_g)||0) * f,
    carbs_g: (Number(per100.carbs_g)||0) * f,
    fat_g: (Number(per100.fat_g)||0) * f
  };
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// USDA key stored locally (quick & dirty)
const KEY_STORAGE = "nutri_usda_key_v1";
function getUSDAKey(){ return (localStorage.getItem(KEY_STORAGE) || "").trim(); }
function setUSDAKey(k){ localStorage.setItem(KEY_STORAGE, k.trim()); }
function clearUSDAKey(){ localStorage.removeItem(KEY_STORAGE); }

function refreshKeyUI(){
  const k = getUSDAKey();
  $("keyStatus").textContent = k ? "gesetzt ‚úÖ" : "nicht gesetzt ‚ùå";
  $("usdaKeyInput").value = k;
  $("topNote").style.display = k ? "none" : "block";
}

// form barcode + source
function clearBarcodeTag(){
  $("manualName").dataset.barcode = "";
  $("activeBarcode").textContent = "‚Äî";
}
function setBarcode(code){
  $("manualName").dataset.barcode = code || "";
  $("activeBarcode").textContent = code || "‚Äî";
}
function setSourceTag(t){
  $("sourceTag").textContent = t || "manuell";
}

function readForm(){
  const nameEl = $("manualName");
  const barcode = (nameEl.dataset.barcode || "").trim() || null;
  const name = nameEl.value.trim() || "Unbenannt";
  const grams = Number($("manualGrams").value)||0;
  const per100 = {
    kcal: Number($("manualKcal").value)||0,
    protein_g: Number($("manualP").value)||0,
    carbs_g: Number($("manualC").value)||0,
    fat_g: Number($("manualF").value)||0
  };
  const meal = $("meal").value;
  const scaled = calcFromPer100(per100, grams);
  return { name, grams, meal, barcode, per100, ...scaled, source: $("sourceTag").textContent };
}

function fillFormFromEntry(e){
  $("manualName").value = e.name || "";
  setBarcode(e.barcode || "");
  $("manualGrams").value = e.grams ?? 0;
  $("manualKcal").value = e.per100?.kcal ?? 0;
  $("manualP").value = e.per100?.protein_g ?? 0;
  $("manualC").value = e.per100?.carbs_g ?? 0;
  $("manualF").value = e.per100?.fat_g ?? 0;
  $("meal").value = e.meal || "Fr√ºhst√ºck";
  setSourceTag(e.source || "manuell");
}

function resetForm(){
  editingId = null;
  $("manualCard").classList.remove("editing");
  $("manualAdd").hidden = false;
  $("manualSave").hidden = true;
  $("manualCancel").hidden = true;
  clearBarcodeTag();
  setSourceTag("manuell");
}

// entries render
function renderEntries(){
  const list = $("entries");
  list.innerHTML = "";
  if (!entries.length){
    list.innerHTML = `<div class="item"><div><b>Keine Eintr√§ge</b><small>Trag etwas ein oder scanne einen Barcode.</small></div></div>`;
    return;
  }
  [...entries].reverse().forEach(e => {
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div style="min-width:240px">
        <b>${escapeHtml(e.name)}</b>
        <small>${escapeHtml(e.meal)} ¬∑ ${e.grams}g ¬∑ ${fmt0(e.kcal)} kcal (P ${fmt(e.protein_g)} / C ${fmt(e.carbs_g)} / F ${fmt(e.fat_g)})</small>
        <small style="opacity:.75">Quelle: ${escapeHtml(e.source || "manuell")}</small>
      </div>
      <div class="actions">
        <span class="pill">${e.barcode ? "EAN: "+escapeHtml(e.barcode) : "manuell"}</span>
        <button class="small ghost" data-act="edit" data-id="${e.id}">‚úèÔ∏è Bearbeiten</button>
        <button class="small danger" data-act="del" data-id="${e.id}">üóëÔ∏è L√∂schen</button>
      </div>
    `;
    list.appendChild(el);
  });

  list.querySelectorAll("button[data-act]").forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if (act === "del") deleteEntry(id);
      if (act === "edit") beginEdit(id);
    };
  });
}

function updateTotals(){
  const sum = entries.reduce((a,e)=>({
    kcal: a.kcal + e.kcal,
    protein_g: a.protein_g + e.protein_g,
    carbs_g: a.carbs_g + e.carbs_g,
    fat_g: a.fat_g + e.fat_g
  }), {kcal:0, protein_g:0, carbs_g:0, fat_g:0});

  $("sumKcal").textContent = fmt0(sum.kcal);
  $("sumP").textContent = fmt(sum.protein_g) + "g";
  $("sumC").textContent = fmt(sum.carbs_g) + "g";
  $("sumF").textContent = fmt(sum.fat_g) + "g";
}

function addEntry(entry){
  entries.push(entry);
  renderEntries();
  updateTotals();
}

function deleteEntry(id){
  const idx = entries.findIndex(e => e.id === id);
  if (idx === -1) return;
  if (!confirm("Eintrag wirklich l√∂schen?")) return;
  entries.splice(idx, 1);
  if (editingId === id) resetForm();
  renderEntries();
  updateTotals();
}

function beginEdit(id){
  const e = entries.find(x => x.id === id);
  if (!e) return;
  editingId = id;
  fillFormFromEntry(e);
  $("manualCard").classList.add("editing");
  $("manualAdd").hidden = true;
  $("manualSave").hidden = false;
  $("manualCancel").hidden = false;
  $("manualCard").scrollIntoView({ behavior: "smooth", block: "start" });
}

function saveEdit(){
  if (!editingId) return;
  const idx = entries.findIndex(e => e.id === editingId);
  if (idx === -1) return resetForm();
  const updated = readForm();
  entries[idx] = { ...entries[idx], ...updated, id: editingId, updatedAt: Date.now() };
  resetForm();
  renderEntries();
  updateTotals();
}

// manual buttons
$("manualAdd").onclick = () => {
  const data = readForm();
  clearBarcodeTag();
  addEntry({
    id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2),
    createdAt: Date.now(),
    ...data
  });
};
$("manualSave").onclick = () => { saveEdit(); clearBarcodeTag(); };
$("manualCancel").onclick = () => { resetForm(); clearBarcodeTag(); };

// USDA suggestions
let debounce = null;
let lastFoods = [];
const sugbox = $("sugbox");

function hideSug(){ sugbox.style.display = "none"; sugbox.innerHTML = ""; lastFoods = []; }
function showSug(foods){
  lastFoods = foods;
  if (!foods.length){ hideSug(); return; }
  sugbox.innerHTML = foods.map((f,i)=>`
    <div class="sugitem" data-i="${i}">
      <b>${escapeHtml(f.name)}</b>
      <small>pro 100g: ${fmt0(f.per100.kcal)} kcal ¬∑ P ${fmt(f.per100.protein_g)} ¬∑ C ${fmt(f.per100.carbs_g)} ¬∑ F ${fmt(f.per100.fat_g)}</small>
    </div>
  `).join("");
  sugbox.style.display = "block";

  sugbox.querySelectorAll(".sugitem").forEach(el => {
    el.onclick = () => {
      const f = lastFoods[Number(el.dataset.i)];
      if (!f) return;
      $("manualName").value = f.name;
      $("manualKcal").value = fmt0(f.per100.kcal);
      $("manualP").value = fmt(f.per100.protein_g);
      $("manualC").value = fmt(f.per100.carbs_g);
      $("manualF").value = fmt(f.per100.fat_g);
      setSourceTag("USDA");
      hideSug();
    };
  });
}

async function usdaSearch(q){
  const key = getUSDAKey();
  if (!key) throw new Error("NO_KEY");
  const url = "https://api.nal.usda.gov/fdc/v1/foods/search" +
    "?query=" + encodeURIComponent(q) +
    "&pageSize=5";
  const res = await fetch(url, { headers: { "X-Api-Key": key } });
  const data = await res.json();
  const foods = (data.foods || []).map(f => {
    const n = f.foodNutrients || [];
    const get = (name) => Number(n.find(x => x.nutrientName === name)?.value || 0);
    return {
      name: f.description,
      per100: {
        kcal: get("Energy"),
        protein_g: get("Protein"),
        carbs_g: get("Carbohydrate, by difference"),
        fat_g: get("Total lipid (fat)"),
      }
    };
  });
  return foods;
}

$("manualName").addEventListener("input", () => {
  clearTimeout(debounce);
  const q = $("manualName").value.trim();
  if (q.length < 3){ hideSug(); return; }
  debounce = setTimeout(async () => {
    try{
      const foods = await usdaSearch(q);
      showSug(foods);
    }catch(e){
      hideSug();
      $("topNote").style.display = "block";
    }
  }, 350);
});

document.addEventListener("click", (e) => {
  const within = e.target.closest(".suggestions");
  if (!within) hideSug();
});

// Open Food Facts lookup
async function offLookup(code){
  const url = `https://world.openfoodfacts.org/api/v2/product/${encodeURIComponent(code)}?fields=code,product_name,nutriments`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data || data.status !== 1) return null;
  const p = data.product || {};
  const n = p.nutriments || {};
  return {
    name: p.product_name || "Unbekanntes Produkt",
    per100: {
      kcal: Number(n["energy-kcal_100g"] || 0),
      protein_g: Number(n["proteins_100g"] || 0),
      carbs_g: Number(n["carbohydrates_100g"] || 0),
      fat_g: Number(n["fat_100g"] || 0),
    }
  };
}

async function applyBarcode(code){
  setBarcode(code);
  $("lastCode").textContent = code || "‚Äî";
  $("scanNote").className = "notice";
  $("scanNote").innerHTML = "<b>Suche in Open Food Facts‚Ä¶</b>";
  try{
    const hit = await offLookup(code);
    if (hit){
      $("manualName").value = hit.name;
      $("manualKcal").value = fmt0(hit.per100.kcal);
      $("manualP").value = fmt(hit.per100.protein_g);
      $("manualC").value = fmt(hit.per100.carbs_g);
      $("manualF").value = fmt(hit.per100.fat_g);
      setSourceTag("OpenFoodFacts");
      $("scanNote").className = "notice ok";
      $("scanNote").innerHTML = "<b>Gefunden.</b> Werte √ºbernommen.";
    } else {
      setSourceTag("manuell");
      $("scanNote").className = "notice err";
      $("scanNote").innerHTML = "<b>Nichts gefunden.</b> Trag Name/N√§hrwerte manuell ein.";
    }
  }catch(e){
    setSourceTag("manuell");
    $("scanNote").className = "notice err";
    $("scanNote").innerHTML = "<b>Fehler beim Lookup.</b> Trag Name/N√§hrwerte manuell ein.";
  }
}

// Scanner
let stream = null;
let detector = null;
let scanRAF = null;
let currentFacing = "environment";

function isSecure(){
  return window.isSecureContext || location.hostname === "localhost" || location.hostname === "127.0.0.1";
}

async function startCamera(){
  $("scanStatus").textContent = "Starte Kamera‚Ä¶";
  $("scanNote").className = "notice";
  $("scanNote").innerHTML = "";

  if (!isSecure()){
    $("scanStatus").textContent = "Kamera nicht verf√ºgbar";
    $("scanNote").className = "notice err";
    $("scanNote").innerHTML = `<b>Kamera-Zugriff blockiert.</b><br>√ñffne die Seite √ºber <code>http://localhost</code> oder HTTPS (GitHub Pages).`;
    return;
  }

  if (!("BarcodeDetector" in window)){
    $("scanStatus").textContent = "Barcode-Scan nicht unterst√ºtzt";
    $("scanNote").className = "notice err";
    $("scanNote").innerHTML = `<b>Dein Browser unterst√ºtzt BarcodeDetector nicht.</b><br>Chrome/Edge nutzen oder sp√§ter ZXing-Fallback.`;
    return;
  }

  try{
    await stopCamera();
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: currentFacing } },
      audio: false
    });
    $("video").srcObject = stream;
    await $("video").play();

    detector = new window.BarcodeDetector({
      formats: ["ean_13","ean_8","upc_a","upc_e","code_128","qr_code"]
    });

    $("scanStatus").textContent = "Suche Barcode‚Ä¶";
    $("scanNote").className = "notice ok";
    $("scanNote").innerHTML = `<b>Scanner l√§uft.</b> Wenn erkannt, √ºbernehmen wir automatisch.`;

    const tick = async () => {
      try{
        const codes = await detector.detect($("video"));
        if (codes && codes.length){
          const raw = (codes[0].rawValue || "").trim();
          if (raw){
            await applyBarcode(raw);
            closeScan();
            return;
          }
        }
      }catch(e){}
      scanRAF = requestAnimationFrame(tick);
    };
    scanRAF = requestAnimationFrame(tick);
  }catch(e){
    $("scanStatus").textContent = "Kamera-Fehler";
    $("scanNote").className = "notice err";
    $("scanNote").innerHTML = `<b>Konnte Kamera nicht starten.</b><br>${escapeHtml(String(e.message||e))}`;
  }
}

async function stopCamera(){
  if (scanRAF) cancelAnimationFrame(scanRAF);
  scanRAF = null;
  detector = null;
  const v = $("video");
  try{ v.pause(); }catch{}
  if (v) v.srcObject = null;
  if (stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

function openScan(){ $("scanModal").style.display = "flex"; startCamera(); }
function closeScan(){ $("scanModal").style.display = "none"; stopCamera(); }

$("scanBtn").onclick = openScan;
$("closeScan").onclick = closeScan;
$("scanModal").onclick = (e) => { if (e.target.id === "scanModal") closeScan(); };
$("switchCam").onclick = async () => { currentFacing = currentFacing === "environment" ? "user" : "environment"; await startCamera(); };
$("manualCodeBtn").onclick = async () => {
  const code = prompt("Barcode eingeben (EAN/UPC):");
  if (!code) return;
  const c = code.trim();
  await applyBarcode(c);
  closeScan();
};

// Settings modal
function openSettings(){ $("settingsModal").style.display = "flex"; refreshKeyUI(); }
function closeSettings(){ $("settingsModal").style.display = "none"; }

$("settingsBtn").onclick = openSettings;
$("closeSettings").onclick = closeSettings;
$("settingsModal").onclick = (e) => { if (e.target.id === "settingsModal") closeSettings(); };

$("saveKeyBtn").onclick = () => {
  const k = $("usdaKeyInput").value.trim();
  if (!k) return;
  setUSDAKey(k);
  refreshKeyUI();
  alert("USDA Key gespeichert (im Browser).");
};
$("clearKeyBtn").onclick = () => {
  if (!confirm("USDA Key wirklich l√∂schen?")) return;
  clearUSDAKey();
  refreshKeyUI();
};

// init
(function init(){
  $("todayPill").textContent = todayISO();
  renderEntries();
  updateTotals();
  resetForm();
  refreshKeyUI();
})();
</script>

</body>
</html>
